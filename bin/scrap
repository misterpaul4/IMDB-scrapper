#!/usr/bin/env ruby
require_relative '../lib/site_obj.rb'
def popular_mv_scrap
  link = SiteObj.new('https://www.imdb.com/chart/moviemeter/?ref_=nv_mv_mpm')
  titles = link.selector('.lister .titleColumn a')
  ratings = link.selector('.lister .imdbRating')
  release_obj = link.selector('.lister-list tr .titleColumn')
  release_dates = extract_date(release_obj)
  [titles, ratings, release_dates]
end

def popular_tv_show_scrap
  link = SiteObj.new('https://www.imdb.com/chart/tvmeter/?ref_=nv_tvv_mptv')
  titles = link.selector('.lister .titleColumn a')
  ratings = link.selector('.lister .imdbRating')
  release_obj = link.selector('.lister-list tr .titleColumn')
  release_dates = extract_date(release_obj)
  [titles, ratings, release_dates]
end

def extract_date(nk_obj)
  dates = []
  nk_obj.each do |item|
    dates.push(/\(\d\d\d\d\)/.match(item.text.to_s.strip).to_s)
  end
  dates
end

def store_data(lists)
  dict = {}
  index = 1
  movie_titles = lists[0]
  movie_ratings = lists[1]
  movie_release_dates = lists[2]
  movie_titles.each do |movie|
    dict[index] = [movie.text, movie_ratings[index - 1].text.strip, movie_release_dates[index - 1]]
    index += 1
  end
  dict # hash containing index as keys, movie title, ratings and year as values
end

def disp_table(to_disp)
  puts 'S/N' + '  Movie'
  puts '=' * 50

  store_data(to_disp).each do |key, value|
    rating = value[1].to_s
    rating = 'no ratings' if value[1].to_s.empty?
    release_date = value[2]
    release_date = 'unknown' if value[2].empty?
    puts key.to_s + ' ' * (5 - key.to_s.length) + 'Title          =>  ' + (value[0]).to_s
    puts ' ' * (key.to_s.length + (5 - key.to_s.length)) + 'imdbRating' + '     =>  ' + rating
    puts ' ' * (key.to_s.length + (5 - key.to_s.length)) + 'Release date' + '   =>  ' + release_date
    puts "\n"
  end
end

disp_table(popular_mv_scrap)
puts "\n\n\n\n"
disp_table(popular_tv_show_scrap)
